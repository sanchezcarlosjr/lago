volumes:
  lago_postgres_data:
  lago_redis_data:
  lago_storage_data:

services:
  db:
    image: postgres:15-alpine
    container_name: lago-db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lago -d lago -h localhost -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      POSTGRES_DB: lago
      POSTGRES_USER: lago
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /data/postgres
      PGPORT: 5432
      POSTGRES_SCHEMA: public
    volumes:
      - lago_postgres_data:/data/postgres

  redis:
    image: redis:7-alpine
    container_name: lago-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: --port 6379
    volumes:
      - lago_redis_data:/data

  rsa-keys:
    image: getlago/api:v1.27.1
    container_name: lago-rsa-keys
    command: ["./scripts/generate.rsa.sh"]
    volumes:
      - lago_rsa_data:/app/config/keys
    restart: "no"

  migrate:
    image: getlago/api:v1.27.1
    container_name: lago-migrate
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
      rsa-keys:
        condition: service_completed_successfully
    command: ["./scripts/migrate.sh"]
    volumes:
      - lago_rsa_data:/app/config/keys
    networks:
      - dokploy-network
      - default
    environment:
      DATABASE_URL: postgresql://lago:${POSTGRES_PASSWORD}@db:5432/lago?search_path=public
      REDIS_URL: redis://redis:6379
      REDIS_PASSWORD: ""
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      LAGO_RSA_PRIVATE_KEY: ""
      LAGO_SIDEKIQ_WEB: "true"
      LAGO_ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_PRIMARY_KEY}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      LAGO_USE_AWS_S3: "false"
      LAGO_USE_GCS: "false"
      LAGO_PDF_URL: http://pdf:3000
      LAGO_REDIS_CACHE_URL: redis://redis:6379
      LAGO_DISABLE_SIGNUP: "false"
      LAGO_OAUTH_PROXY_URL: https://proxy.getlago.com

  api:
    image: getlago/api:v1.27.1
    container_name: lago-api
    restart: unless-stopped
    depends_on:
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["./scripts/start.api.sh"]
    healthcheck:
      test: curl -f http://localhost:3000/health || exit 1
      interval: 10s
      start_period: 30s
      timeout: 60s
    environment:
      DATABASE_URL: postgresql://lago:${POSTGRES_PASSWORD}@db:5432/lago?search_path=public
      REDIS_URL: redis://redis:6379
      REDIS_PASSWORD: ""
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      LAGO_RSA_PRIVATE_KEY: ""
      LAGO_SIDEKIQ_WEB: "true"
      LAGO_ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_PRIMARY_KEY}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      LAGO_USE_AWS_S3: "false"
      LAGO_USE_GCS: "false"
      LAGO_PDF_URL: http://pdf:3000
      LAGO_REDIS_CACHE_URL: redis://redis:6379
      LAGO_DISABLE_SIGNUP: "false"
      LAGO_OAUTH_PROXY_URL: https://proxy.getlago.com
      LAGO_API_URL: ${LAGO_API_URL}
      LAGO_FRONT_URL: ${LAGO_FRONT_URL}
      LAGO_FROM_EMAIL: ${LAGO_FROM_EMAIL:-}
      LAGO_SMTP_ADDRESS: ${LAGO_SMTP_ADDRESS:-}
      LAGO_SMTP_PORT: ${LAGO_SMTP_PORT:-587}
      LAGO_SMTP_USERNAME: ${LAGO_SMTP_USERNAME:-}
      LAGO_SMTP_PASSWORD: ${LAGO_SMTP_PASSWORD:-}
      LAGO_LICENSE: ${LAGO_LICENSE:-}
      GOOGLE_AUTH_CLIENT_ID: ${GOOGLE_AUTH_CLIENT_ID:-}
      GOOGLE_AUTH_CLIENT_SECRET: ${GOOGLE_AUTH_CLIENT_SECRET:-}
    volumes:
      - lago_storage_data:/app/storage
      - lago_rsa_data:/app/config/keys
      
  front:
    image: getlago/front:v1.27.1
    container_name: lago-front
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    ports:
      - 3001:3000
    environment:
      API_URL: ${LAGO_API_URL}
      APP_ENV: production
      LAGO_OAUTH_PROXY_URL: https://proxy.getlago.com
      LAGO_API_URL: ${LAGO_API_URL}
      LAGO_FRONT_URL: ${LAGO_FRONT_URL}

  api-worker:
    image: getlago/api:v1.27.1
    container_name: lago-worker
    restart: unless-stopped
    depends_on:
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["./scripts/start.worker.sh"]
    healthcheck:
      test: curl -f http://localhost:8080 || exit 1
      interval: 10s
      start_period: 30s
      timeout: 60s
    environment:
      DATABASE_URL: postgresql://lago:${POSTGRES_PASSWORD}@db:5432/lago?search_path=public
      REDIS_URL: redis://redis:6379
      REDIS_PASSWORD: ""
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      LAGO_RSA_PRIVATE_KEY: ""
      LAGO_SIDEKIQ_WEB: "true"
      LAGO_ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_PRIMARY_KEY}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      LAGO_USE_AWS_S3: "false"
      LAGO_USE_GCS: "false"
      LAGO_PDF_URL: http://pdf:3000
      LAGO_REDIS_CACHE_URL: redis://redis:6379
      LAGO_DISABLE_SIGNUP: "false"
      LAGO_OAUTH_PROXY_URL: https://proxy.getlago.com
      LAGO_API_URL: ${LAGO_API_URL}
    volumes:
      - lago_storage_data:/app/storage
      - lago_rsa_data:/app/config/keys

  api-clock:
    image: getlago/api:v1.27.1
    container_name: lago-clock
    restart: unless-stopped
    depends_on:
      migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["./scripts/start.clock.sh"]
    volumes:
      - lago_rsa_data:/app/config/keys
    environment:
      DATABASE_URL: postgresql://lago:${POSTGRES_PASSWORD}@db:5432/lago?search_path=public
      REDIS_URL: redis://redis:6379
      REDIS_PASSWORD: ""
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      LAGO_RSA_PRIVATE_KEY: ""
      LAGO_SIDEKIQ_WEB: "true"
      LAGO_ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_PRIMARY_KEY}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_ENCRYPTION_DETERMINISTIC_KEY}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_ENCRYPTION_KEY_DERIVATION_SALT}
      LAGO_USE_AWS_S3: "false"
      LAGO_USE_GCS: "false"
      LAGO_PDF_URL: http://pdf:3000
      LAGO_REDIS_CACHE_URL: redis://redis:6379
      LAGO_DISABLE_SIGNUP: "false"
      LAGO_OAUTH_PROXY_URL: https://proxy.getlago.com
      LAGO_API_URL: ${LAGO_API_URL}

  pdf:
    image: getlago/lago-gotenberg:8.15
    container_name: lago-pdf
    restart: unless-stopped
    command:
      - gotenberg
      - --libreoffice-disable-routes=true
      - --chromium-ignore-certificate-errors=true
      - --chromium-disable-javascript=true
      - --api-timeout=300s
